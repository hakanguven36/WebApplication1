@{
    ViewData["Title"] = "Home Page";
}

@section Styles {
    <style>
        .secBtn {
            color: white;
        }
            .secBtn:hover {
                color: white !important;
            }
    </style>
}
<input type="hidden" id="imagesrc" value="@ViewBag.path"/>
<input type="hidden" id="seenBackend" value="@ViewBag.seen" />
<input type="hidden" id="imageID" value="@ViewBag.imageID" />
<input type="hidden" id="filesCount" value="@ViewBag.filesCount" />
<input type="hidden" id="imageNo" value="@ViewBag.imageNo" />

@if (!string.IsNullOrWhiteSpace(ViewBag.hata))
{
    <span class="text-danger">HATA: @ViewBag.hata</span>
}
<table class="table-sm table-borderless" style="width:100%">
    <tr>
        <td colspan="2" style="border-bottom:1px gray solid; padding-bottom:18px">
            <span>
                <span id="naviScreen" style="cursor:pointer" class="p-2"></span>
            </span>
            <button class="btn btn-sm btn-secondary" onclick="NavigateBackward()"><< Geri</button>
            <button class="btn btn-sm btn-secondary" onclick="NavigateForward()">İleri >></button>
            <span class="p-2">
                <select id="seen" class="form-control-sm">
                    <option value="0">İşlenmemişler</option>
                    <option value="1">İşlenmişler</option>
                    <option value="2">Tamamı</option>
                </select>
            </span>
            <span class="p-2"> || </span>
            <button class="btn btn-sm btn-success" onclick="Completed()"> Etiketleri Kaydet </button>
            <span class="p-2"> || </span>
            <button class="btn btn-sm btn-outline-danger" onclick="DeletePhoto()"> Resmi Sil </button>
        </td>
    </tr>
    <tr>
        <td colspan="2" style="padding-top:18px">
            <button class="btn secBtn" onclick="ChooseLabel(0)" style="background-color:darkslategray">Toprak</button>
            <button class="btn secBtn" onclick="ChooseLabel(1)" style="background-color:darkgreen">Kültür</button>
            <button class="btn secBtn" onclick="ChooseLabel(2)" style="background-color:orangered">YabancıOt</button>
            <button class="btn secBtn" onclick="ChooseLabel(3)" style="background-color:royalblue">%50 Kültür+Yabancı</button>
            &nbsp;&nbsp;||&nbsp;&nbsp;
            <button class="btn btn-sm secBtn" onclick="ClearClasses()" style="background-color:black">Tümünü Temizle!</button>
        </td>
    </tr>
    <tr>
        <td style="vertical-align:top">
            <div style="margin: 2px">
                <span style="border: solid 1px gray; border-radius: 2px; padding: 3px">
                    <span style="margin: 4px; margin-right: 10px; cursor: pointer" onclick="CanvasChangeSize(false)">-</span>
                    <span style="margin: 4px; margin-left: 10px; cursor: pointer" onclick="CanvasChangeSize(true)">+</span>
                </span>
                <span class="ml-4">
                    Opacity:
                    <input type="range" oninput="LabelPaintRange(this.value)" value="30" step="10" />
                </span>
                <span class="ml-4">
                    Grid:
                    <span class="btn-group-sm">
                        <button class="btn btn-outline-dark">#128</button>
                        <button class="btn btn-outline-dark">#320</button>
                        <button class="btn btn-outline-dark">#640</button>
                        <button class="btn btn-outline-dark">#1280</button>
                        -
                        <button class="btn btn-outline-primary">FreeDraw</button>
                    </span>
                </span>
            </div>
            <span>
                <canvas id="canvas"></canvas>
            </span>
        </td>
        <td style="vertical-align:top;">
            <div style="margin: 2px">
                <span style="border: solid 1px gray; border-radius: 2px; padding: 3px">
                    <span style="margin: 4px; margin-right: 10px; cursor: pointer" onclick="FlyingCanvasChangeSize(false)">-</span>
                    <span style="margin: 4px; margin-left: 10px; cursor: pointer" onclick="FlyingCanvasChangeSize(true)">+</span>
                </span>
            </div>
            <span>
                <canvas id="manvas"></canvas>
            </span>
        </td>
    </tr>
</table>


<script>

    // #region Definitions
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const manvas = document.getElementById("manvas");
    const ctxm = manvas.getContext("2d");

    const image = new Image();
    image.src = $("#imagesrc").val();

    var seenBackend = $("#seenBackend").val();
    $("#seen").val(seenBackend).change();

    const imageID = Number($("#imageID").val());
    const filesCount = Number($("#filesCount").val());
    var imageNo = Number($("#imageNo").val());
    const naviScreen = $("#naviScreen");
    var oran = 1;
    // #endregion
    // #region Label Class
    class Label {
        constructor(id, label, posX, posY, wid, hei, PhotoID) {
            this.id = id;
            this.label = label;
            this.posX = posX;
            this.posY = posY;
            this.wid = wid;
            this.hei = hei
            this.PhotoID = PhotoID;
        }
        Stringify() {
            return JSON.stringify(this);
        }
        IsEqual(someLabel) {
            return JSON.stringify(someLabel) == JSON.stringify(this);
        }
    }
    var labelList = [];
    class Point {
            X;
            Y;
    }
    const mouse = new Point();

    // #endregion
    // #region Preferences
    var canvasDesiredWidth = 1000;
    var manvasDesiredWidth = 600;
    var lineWidth = 2;
    var Colors = ["black", "green", "red", "blue", "purple"];
    var labelOpacity = 0.3;
    // #endregion
    // #region Variables
    // #endregion
    // #region INITIAL
    function CanvasesInit() {
        canvas.width = canvas.height = canvasDesiredWidth;
        manvas.width = manvas.height = manvasDesiredWidth;
        ctx.fillStyle = "darkgray";
        ctxm.fillStyle = "darkgray";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctxm.fillRect(0, 0, manvas.width, manvas.height);
    }
    
    image.onload = function () {
        
        CanvasesInit();
        CanvasDrawImage();
        printNaviScreen();
    };
    // #endregion
    

    function CanvasDrawImage() {
        if (image.height) {
            oran = image.width / image.height;
            canvas.width = image.width;
            canvas.height = canvas.width / oran;
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height, 0, 0, image.width, image.height);
        }
    }

    // #region Navigation
    function NavigateBackward() {
        imageNo--;
        Number(imageNo).clamp(1, filesCount);
        GoToImageNo();
    }

    function NavigateForward() {
        imageNo++;
        Number(imageNo).clamp(1, filesCount);
        GoToImageNo();
    }
    function GoToImageNo() {
        window.location = "/Home/Index?_imageNo=" + imageNo;

    }
    function printNaviScreen() {
        naviScreen.html(imageNo + " / " + filesCount);
    }
    naviScreen.click(function () {
        var naviinput = $("<input>");
        naviinput.css({ "width": "5em", "border-radius": "0.4em" });
        naviinput.keyup(function (e) {
            if (e.keyCode == 13) {
                imageNo = naviinput.val();
                Number(imageNo).clamp(1, filesCount);
                GoToImageNo();
            }
        });
        $(this).parent().html(naviinput);
        naviinput.focus();
    });
    $("#seen").change(function () {
        window.location = "/Home/Index?_seen=" + $(this).val();
    });
    // #endregion

    canvas.addEventListener("mousemove", function (e) {
        mouse.X = e.offsetX;
        mouse.Y = e.offsetY;
        UpdateAll();
    });

    function UpdateAll() {
        CanvasDrawImage();
        CrossHair();
        DrawKare();
    }

    function CrossHair() {
        ctx.strokeStyle = "white";
        ctx.lineWidth = 2;
        ctx.globalAlpha = 0.4;

        // vertical line
        ctx.moveTo(mouse.X, 0);
        ctx.lineTo(mouse.X,canvas.height);
        ctx.stroke();
        // horizontal line
        ctx.moveTo(0, mouse.Y);
        ctx.lineTo(canvas.width, mouse.Y);
        ctx.stroke();
        ctx.globalAlpha = 1.0;
    }

    var isKareDrawn = false;
    var kareStart = new Point();
    var kareEnd = new Point();
    canvas.addEventListener("mousedown", function () {
        kareStart.X = mouse.X;
        kareStart.Y = mouse.Y;
    });
    canvas.addEventListener("mouseup", function () {
        kareEnd.X = mouse.X;
        kareEnd.Y = mouse.Y;
        CreateKare();
    });
    function CreateKare() {
        isKareDrawn = true;
    }
    function DrawKare() {
        if (isKareDrawn) {
            ctx.lineWidth = 4;
            ctx.strokeStyle = "red";
            ctx.beginPath();
            ctx.rect(kareStart.X, kareStart.Y, kareEnd.X - kareStart.X, kareEnd.Y - kareStart.Y);
            ctx.stroke();
        }
    }


</script>

<!--


@*
    <script>

        var canvasDesiredWidth = 1000;
        var flyingCanvasDesiredWidth = 600;
        var lineWidth = 2;
        var Colors = ["black", "green", "red", "blue", "purple"]

        var imageNo = 0;
        var filesCount = 0;
        var seenorwhat = 0;
        var gridSize = 128;
        var secimler = [];
        var imageID = 0;
        var etiketPaintRange = 0.3;
        var cursor = { col: 0, row: 0 };

        $(document).ready(function () {
            filesCount = Number($("#filesCount").val());
            imageNo = Number($("#imageNo").val());
            imageID = Number($("#imageID").val());
            $("#seen").val($("#seenBackend").val());
            GetLabels();
        });

        function GetLabels() {
            new OzAjax("/Home/GetEtiketler", GET, { imageID: imageID }, GetEtBasari).Send();
            function GetEtBasari(data) {
                secimler = JSON.parse(data);
                PaintChosenGrids();
            }
        }

        //___CANVAS___//
        // Get image Info
        var image, imageWidth, imageHeight, gridCountX, gridCountY, cursorindex;
        // create canvas
        var canvas, ctx, percentage, cGridSize, flyingCanvas, ctx2;

        $("#image").on("load", function () {
            // Get image Info
            image = document.getElementById("image");
            imageWidth = image.width; // should be 1280
            imageHeight = image.height;
            gridCountX = Math.floor(imageWidth / gridSize);
            gridCountY = Math.floor(imageHeight / gridSize);

            cursorindex = 0;

            // create canvas
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");
            percentage = imageWidth / imageHeight;
            canvas.width = canvasDesiredWidth;
            canvas.height = canvas.width / percentage;

            flyingCanvas = document.getElementById("flyingCanvas");
            ctx2 = flyingCanvas.getContext("2d");
            flyingCanvas.width = flyingCanvasDesiredWidth;
            flyingCanvas.height = flyingCanvasDesiredWidth;

            UpdateAll();
        });

        function UpdateAll() {
            DrawImage();
            DrawGrid();
            PaintChosenGrids();
            DrawRedRect();
            DrawFlyingImage();
        }

        function DrawImage() {
            ctx.drawImage(image, 0, 0, imageWidth, imageHeight, 0, 0, canvas.width, canvas.height);
        }
        function DrawGrid() {
            ctx.strokeStyle = "white";
            ctx.lineWidth = lineWidth;

            // fixing cGridSize value
            cGridSize = gridSize * (canvasDesiredWidth / imageWidth);

            // vertical lines
            for (var i = 0; i <= gridCountX; i++) {
                ctx.moveTo(i * cGridSize, 0);
                ctx.lineTo(i * cGridSize, gridCountY * cGridSize);
                ctx.stroke();
            }
            // horizontal lines
            for (var i = 0; i <= gridCountY; i++) {
                ctx.moveTo(0, i * cGridSize);
                ctx.lineTo(gridCountX * cGridSize, i * cGridSize);
                ctx.stroke();
            }
        }

        function PaintChosenGrids() {
            ctx.globalAlpha = etiketPaintRange;

            var x, y, w, h;
            for (var i = 0; i < secimler.length; i++) {

                ctx.fillStyle = Colors[secimler[i].choice];

                x = cGridSize * secimler[i].cursorCol;
                y = cGridSize * secimler[i].cursorRow;
                w = cGridSize;
                h = cGridSize;

                ctx.fillRect(x + 2, y + 2, w - 4, h - 4);
            }
            ctx.globalAlpha = 1.0;
        }

        function DrawRedRect() {
            ctx.lineWidth = 4;
            ctx.strokeStyle = "red";
            ctx.beginPath();
            ctx.rect(cursor.col * cGridSize, cursor.row * cGridSize, cGridSize, cGridSize);
            ctx.stroke();
        }

        function DrawFlyingImage() {
            ctx2.drawImage(image, cursor.col * gridSize, cursor.row * gridSize, gridSize, gridSize, 0, 0, flyingCanvas.width, flyingCanvas.height);
        }


        function CanvasChangeSize(increase) {
            if (increase)
                canvasDesiredWidth += 50;
            else
                canvasDesiredWidth -= 50;
            canvasDesiredWidth = canvasDesiredWidth < 200 ? 200 : canvasDesiredWidth;
            canvas.width = canvasDesiredWidth;
            canvas.height = canvas.width / percentage;
            UpdateAll();
        }
        function FlyingCanvasChangeSize(increase) {
            if (increase)
                flyingCanvasDesiredWidth += 50;
            else
                flyingCanvasDesiredWidth -= 50;
            flyingCanvasDesiredWidth = flyingCanvasDesiredWidth < 200 ? 200 : flyingCanvasDesiredWidth;
            flyingCanvas.width = flyingCanvasDesiredWidth;
            flyingCanvas.height = flyingCanvasDesiredWidth;
            DrawFlyingImage();
        }

        //___NAVIGATION___//
        function NavigateBackward() {
            console.log("imageNo" + imageNo);
            imageNo -= 1;
            if (imageNo < 1) {
                imageNo = 1;
                return;
            }
            console.log("yeni image index" + imageNo);
            window.location = "/Home/Index/" + imageNo;
        }

        function NavigateForward() {
            imageNo += 1;
            if (imageNo > filesCount) {
                imageNo = filesCount;
                return;
            }
            window.location = "/Home/Index/" + imageNo;
        }

        function CursorIncrease() {
            cursorindex = gridCountX * cursor.row + cursor.col;
            cursorindex++;
            if (cursorindex > gridCountX * gridCountY - 1)
                cursorindex = 0;

            cursor.row = Math.floor(cursorindex / gridCountX);
            cursor.col = cursorindex - (cursor.row * gridCountX);

            UpdateAll();
        }

        $("#canvas").click(function (e) {
            cursor.col = Math.floor(e.offsetX / cGridSize);
            cursor.row = Math.floor(e.offsetY / cGridSize);
            cursor.row = (cursor.row > gridCountY - 1) ? gridCountY - 1 : cursor.row;
            UpdateAll();
        });



        function ChooseLabel(choice) {
            var pack = { imageNo: imageNo, choice: choice, cursorCol: cursor.col, cursorRow: cursor.row };
            var packExist = false;
            for (var i = 0; i < secimler.length; i++)
                // pack zaten varsa sadece choice değerini değiştir.. array.push yapma!
                if (secimler[i].cursorCol == pack.cursorCol && secimler[i].cursorRow == pack.cursorRow) {
                    secimler[i].choice = pack.choice;
                    packExist = true;
                }

            if (!packExist) {
                secimler.push({ choice: choice, cursorCol: cursor.col, cursorRow: cursor.row, cursorSize: gridSize });
            }

            CursorIncrease();
        }

        function ClearClasses() {
            secimler = [];
            UpdateAll();
        }

        function Completed() {

            new OzAjax("/Home/Tamamlanan", POST, { secimler: secimler, imageID: imageID }, KaydetBasari, KaydetHata).Send();
            function KaydetBasari(data) {
                alert(data);
                NavigateForward();
            }
            function KaydetHata(error) {
                alert(error);
            }
        }


        $("#seenorwhat").change(function () {
            seenorwhat = $(this).val();
            window.location = "/Home/Index/" + imageNo + "?seenorwhat=" + seenorwhat;
        });

        function LabelPaintRange(value) {

            etiketPaintRange = value / 100.0;
            UpdateAll();
        }

        class Label {
            constructor(label, posX, posY, wid, hei, PhotoID) {
                this.label = label;
                this.posX = posX;
                this.posY = posY;
                this.wid = wid;
                this.hei = hei
                this.PhotoID = PhotoID;
            }
            Stringify() {
                return JSON.stringify(this);
            }
            IsEqual(someLabel) {
                return JSON.stringify(someLabel) == JSON.stringify(this);
            }
        }
        var label = new Label();

    </script>

*@
-->
